# HEIC/HEIF変換ツール 技術仕様書 (v1.0)

## 1. 概要 (Overview)

本ツールは、ブラウザ上で完結するクライアントサイド（ローカル）のWebアプリケーションであり、ユーザーがドラッグ＆ドロップで入力したHEIC/HEIF形式の画像を、指定された形式（JPEGまたはPNG）に変換し、ダウンロード機能を提供する。すべての処理はユーザーのブラウザ内で実行され、データの外部送信やサーバー通信は行わない。

## 2. 技術スタック (Technical Stack)

| **要素** | **技術/ライブラリ** | **備考** |
| --- | --- | --- |
| 
**フロントエンド**

 | 

HTML5, CSS3, JavaScript (ES2020+)

 | 

最新のWeb標準を使用。

 |
| 

**スタイリング**

 | 

Tailwind CSS

 | 

レスポンシブデザインの迅速な実装と統一感のあるUIのために採用。

 |
| 

**HEICデコード**

 | 

`libheif` をベースとしたJavaScript/WebAssemblyライブラリ

 | 

例: `heic2any` または類似の、ブラウザでHEICをデコードできるライブラリ。

 |
| 

**ZIPアーカイブ**

 | 

`jszip`

 | 

複数ファイルの一括ダウンロード用に、クライアントサイドでZIPを生成。

 |
| 

**非同期処理**

 | 

`Promise` / `async/await`

 | 

ファイルの順次処理、デコード、エンコードを非同期的に実行する。

 |

**重要:** すべてのコード（HTML, CSS, JavaScript）は単一のHTMLファイル（`index.html`など）に記述すること。外部ファイル参照は、上記ライブラリのCDN利用に限定する。

## 3. アーキテクチャ (Architecture)

### 3.1. アプリケーション構成

| **モジュール** | **役割** |
| --- | --- |
| 
**File Handler**

 | 

ファイル入力（D&D）の受付、ファイルオブジェクトの管理。

 |
| 

**UI Renderer**

 | 

ファイルリスト、設定、ステータス表示などのDOM操作全般。

 |
| 

**Conversion Engine**

 | 

外部ライブラリを介したHEICデコード、Canvas APIを使用したJPEG/PNGエンコードを担当。

 |
| 

**Download Manager**

 | 

変換完了後のBlobデータの管理、単一ファイルのダウンロード、`jszip`を使用したZIPアーカイブの生成とダウンロードを実行。

 |

### 3.2. 処理フロー

1.  **初期状態**: UIはファイル入力エリアと変換設定セクションのみを表示。
2.  **ファイル入力**: ユーザーがHEICファイルをD&D。
3.  **リスト表示**: File Handlerがファイルオブジェクトを取得し、UI Rendererがファイル一覧と設定を表示。
4.  **設定確定**: ユーザーが変換形式（JPEG/PNG）を指定し、「変換実行」ボタンをクリック。
5.  **変換シーケンス**: Conversion Engineがファイルリストを非同期で**順次処理**。
    
    *   a. `File`オブジェクトを読み込み、HEICデコーダーでデコード。
    *   b. デコード結果を`Canvas`に描き、選択された形式（JPEG/PNG）で`Blob`としてエンコード。
    *   c. 処理中のファイル行のステータスを「処理中」に更新。
6.  **ステータス更新**: 1ファイル処理完了ごとに、そのファイルのステータスを「完了」に更新。
7.  **全処理完了**: 全ファイル処理完了後、Download ManagerがZIP生成（複数ファイルの場合）または単一Blob準備（単一ファイルの場合）を行い、UI Rendererが「ダウンロード」ボタンに切り替える。
8.  **ダウンロード**: ユーザーがボタンをクリックし、ファイルまたはZIPアーカイブをダウンロード。

## 4. UI/UX 仕様 (UI/UX Specification)

### 4.1. 画面構成 (Screen Layout)

全体として、中央寄せでモダンかつ応答性の高いデザインを採用する。

1.  **ヘッダー**: ツール名（例: HEIC Local Converter）と簡単な説明。
2.  **ファイル入力エリア (Drop Zone)**:
    
    *   画面中央に大きく配置。
    *   初期状態では「HEICファイルをここにドラッグ＆ドロップしてください」のメッセージを表示。
    *   ファイル受け付け中は視覚的なフィードバック（枠線の変化など）を提供。
3.  **設定・操作エリア (Control Panel)**:
    
    *   ファイル入力後に表示される。
    *   **変換形式選択**: ラジオボタンまたはセレクトボックスで「JPEG (JPG)」または「PNG」を選択可能とする。（デフォルトはJPEG）。
    *   **変換実行ボタン**: 「変換を実行」 (初期状態) / 「ダウンロード」 (完了後) に変化。
4.  **ファイルリストエリア (File List)**:
    
    *   テーブルまたはリスト形式で表示。
    *   レスポンシブ対応（モバイルでは列の表示を調整）。

### 4.2. ファイルリスト表示項目

| **項目** | **表示内容** | **備考** |
| --- | --- | --- |
| 
**ファイル名**

 | 

入力された元のファイル名 (`.heic` or `.heif`)。

 | 

  


 |
| 

**サイズ**

 | 

元ファイルのサイズ (MB表示)。

 | 

  


 |
| 

**形式**

 | 

ユーザーが選択した変換後の形式 (JPG / PNG)。

 | 

  


 |
| 

**ステータス**

 | 

処理の進捗を示す。（「待機中」 -> 「処理中」 -> 「完了」 -> 「エラー」）

 | 

  


 |
| 

**進捗**

 | 

処理中の場合はプログレスバーまたはアイコンを表示。

 | 

  


 |

### 4.3. インタラクション (Interaction)

*   **Drag & Drop**:
    
    *   ドラッグオーバー時は、Drop Zoneがハイライトされること。
    *   受け付けるファイルタイプはHEIC/HEIF (`image/heic`, `image/heif`) のみに限定し、それ以外のファイルがドロップされた場合は、警告メッセージを表示し、処理しないこと。
*   **変換処理中**:
    
    *   変換実行ボタンを無効化し、「処理中...」といった表示に切り替える。
    *   処理中のファイル行には明確なインジケータ（スピナーなど）を表示する。
    *   変換が完了したファイルには緑色のチェックマークを表示する。
*   **エラー発生時**:
    
    *   エラーが発生したファイル行のステータスを「エラー」に切り替え、具体的なエラーメッセージ（例: 「デコードに失敗しました」）を赤字で表示する。
    *   全体の処理は停止せず、次のファイルに進むこと。

## 5. 機能仕様 (Functional Specification)

### 5.1. ファイル入力と管理

*   **入力形式**: `DataTransfer.items`から`File`オブジェクトを取得し、内部で`FileList`または`Map<string, File>`として管理する。
*   **ファイル重複**: 複数回D&Dがあった場合、リストに追加する（既存のファイルは上書きしない）。
*   **初期チェック**: 拡張子が`.heic`または`.heif`であることを確認する。

### 5.2. 変換処理 (Conversion Engine)

*   **処理順序**: ユーザーが「変換実行」をクリックした後、リストに追加された順に**1つずつ**（順次）非同期処理を実行する。
*   **デコード**: 選択したHEICデコードライブラリを使用して、HEIC/HEIFデータをブラウザが扱える形式（`canvas`または`Blob`）に変換する。
*   **エンコード設定**:
    
    *   **JPEG**: `canvas.toBlob('image/jpeg', quality)`を使用し、\*\*品質パラメーターは0.9 (90%)\*\*に固定する。
    *   **PNG**: `canvas.toBlob('image/png')`を使用する。
*   **メタデータ**: HEICに含まれるExifメタデータがデコードライブラリで取得可能な場合、可能な限り変換後のJPEGファイルに引き継ぐことを試みる。（ただし、これはデコーダーライブラリの機能に依存するため、非必須要件とするが、実装が容易であれば行う。）
*   **エラーハンドリング**: いずれかの処理（ファイル読み込み、デコード、エンコード）でエラーが発生した場合、そのファイルの処理をスキップし、次のファイルの処理に進む。

### 5.3. 出力とダウンロード (Download Manager)

変換完了後、すべての処理結果を管理し、ユーザーの操作に応じてダウンロードを行う。

| **ケース** | **ダウンロード対象** | **ファイル名生成規則** |
| --- | --- | --- |
| 
**単一ファイル**

 | 

変換後の画像Blob (JPEG/PNG)

 | 

`{元のファイル名(拡張子なし)}_{timestamp}.{新拡張子}`

 |
| 

**複数ファイル**

 | 

ZIPアーカイブ

 | 

`HEIC_Converted_{timestamp}.zip`

 |

*   **ZIPアーカイブ内容**: 変換されたすべての画像ファイル（エラーとなったファイルは除く）。内部のファイル名は単一ファイルの場合の命名規則に準拠。
*   **Timestamp**: `YYYYMMDDhhmmss`形式で生成。
*   **ダウンロードトリガー**: `URL.createObjectURL`を使用してBlob URLを作成し、`<a>`要素の`download`属性と`click()`メソッドでダウンロードをシミュレートする。（ユーザーがダウンロードボタンを押した後に実行。）

## 6. 実装上の留意点 (Implementation Notes)

### 6.1. パフォーマンス

*   **Canvas再利用**: 複数のファイルの変換を行う際、不必要なDOM操作を避けるため、内部で使用する`<canvas>`要素は使い回す（再利用する）設計とする。
*   **メモリ管理**: 処理完了後、`URL.revokeObjectURL()`の呼び出し、および変換に使用した大きな中間`Blob`や`ArrayBuffer`の参照解除を徹底し、ブラウザのメモリリークを防ぐこと。

### 6.2. ユーザー認証

*   本ツールは完全にローカルで動作するため、Firebaseなどの認証機能は**不要**とする。

### 6.3. 環境変数とAPIキー

*   外部API（Google Gemini APIなど）やAPIキー、およびFirebaseの利用は**一切不要**とする。

### 6.4. エラー表示

*   ユーザーに優しいエラーメッセージを提供すること。一般的なエラー（例: ファイル形式の誤り）と技術的なエラー（例: デコードライブラリの初期化失敗）を区別して表示する。

### 6.5. レスポンシブデザイン

*   Tailwind CSSのブレークポイントを適切に活用し、デスクトップ、タブレット、モバイルのどの環境でも使用しやすいレイアウトを保証すること。特にDrop Zoneはタッチ操作でも扱いやすいサイズとすること。

以上が、本ツールの完全な仕様技術書です。開発者はこの仕様に基づき、すぐに実装を開始できます。